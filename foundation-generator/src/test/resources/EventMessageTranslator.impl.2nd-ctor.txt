package test.event.generated

import kotlin.Boolean
import kotlinx.serialization.json.Json
import net.ntworld.foundation.Message
import net.ntworld.foundation.MessageAttribute
import net.ntworld.foundation.MessageTranslator
import net.ntworld.foundation.MessageUtility
import test.event.CreatedEvent
import test.event.CreatedEventImpl

object CreatedEventImplMessageTranslator : MessageTranslator<CreatedEvent> {
  private val json: Json = Json

  private fun make(event: CreatedEventImpl): CreatedEventImpl = CreatedEventImpl(event)

  override fun canConvert(message: Message): Boolean {
    val bodyType = message.attributes["bodyType"]
    return null !== bodyType && bodyType.stringValue == "test.event.CreatedEvent"
  }

  override fun fromMessage(message: Message): CreatedEventImpl =
      json.decodeFromString(CreatedEventImpl  .serializer(), message.body)

  override fun toMessage(input: CreatedEvent): Message {
    val attributes = mapOf<String, MessageAttribute>(
      "bodyType" to MessageUtility.createStringAttribute(
        "test.event.CreatedEvent"
      ),
      "implementationType" to MessageUtility.createStringAttribute(
        "test.event.CreatedEventImpl"
      )
    )

    return MessageUtility.createMessage(
      json.encodeToString(CreatedEventImpl.serializer(), make(input)),
      attributes
    )
  }
}
